# 斗地主设计文档

计97 胡沐彦 2019013269

## 程序结构

### 扑克牌

在 `card.h/card.cpp` 中实现。

+ `enum CardSuit` 和 `enum CardPoint` 分别表示牌的点数和花色

+ `struct Card` 用于存储一张扑克牌，包括花色 $\rm suit$ 和点数 $\rm point$，同时支持以 $\rm suit\times 13+point$ 的方式将 `Card` 与整数互相转换
+ `class Cards` 用于存储一些扑克牌，除支持基本的加入、删除、导出扑克牌操作之外，内嵌了牌型判断、比较牌型大小等操作
  + 牌型判断的原理：先算出点数重复出现 $1\sim 4$ 次的牌各有几张，然后根据不同牌型的特性进行判断
  + 比较牌型大小先判断比较的两个 `Cards` 是否拥有相同的牌型（除炸弹）以及如果是顺子、连对长度是否相同，然后再找到决定大小的牌的点数（如三带二的三，顺子最大的一张牌）

### 服务器

在 `server.h/server.cpp` 中实现。

+ `class Server` 为一个继承自 `QObject` 的类，表示服务器
+ 服务器主要负责向客户端发出叫地主、出牌等指令，以及向客户端广播更新的游戏状态
+ 用信号槽机制完成与客户端的连接、收发信息

### 客户端

在 `mainwindow.h/mainwindow.cpp` 中实现。

+ `class MainWindow` 中带有一个 `class Server*` 变量，如果客户端一开始尝试连接服务器失败，则自己新建一个 `class Server`，即最先开始连接的客户端同时作为服务器
+ `class UICard` 继承自 `class Card`，保存了一张牌的图片（用 `QImage` 存储）、长宽大小、是否被选中等信息，为绘图做准备
+ 记录上一位玩家的出牌、自己是否可以不出等信息
+ 同样以信号槽机制完成与服务器的连接、收发信息
+ 利用 `resizeEvent` 完成扑克牌大小缩放、游戏界面缩放的功能，在 `paintEvent` 中计算合适的位置绘制扑克牌和按钮、文字

### 通信协议

服务器与客户端之间通过发送json包收发消息，json包中含有如下字段：

+ `messageType`：表明消息类型，如发牌、叫地主等
+ `clientID`：客户端向服务器发送消息时用以表明发送者身份
+ `cards`：发送一些牌时使用，为一个若干整数构成的json数组
+ 其他各类消息需要的各种信息

## 游戏界面

### 连接

+ 当客户端“开始连接”按钮被点击时，尝试连接127.0.0.1的59583端口，如果连接失败则新建服务器，如果连接成功则服务器给客户端分配一个ID
+ 三个客户端都与服务器连接成功后，进入发牌和叫地主阶段

### 发牌和叫地主

+ 服务器随机出手牌和地主牌并分发给三个客户端，然后随机一个客户端向其发送叫地主指令
+ 客户端收到叫地主指令后显示“叫/抢地主”按钮和“不叫/不抢”按钮，玩家决定后客户端将结果发送给服务器
+ 服务器收到一个客户端的结果后，更新地主信息；如果三个客户端都发过叫/抢地主指令则广播地主结果，进入出牌阶段，否则向下一个客户端发送叫/抢地主指令
+ 客户端收到地主结果后，展示三张地主牌，如果自己是地主则把地主牌加入手牌

### 出牌

+ 服务器首先向地主发出出牌指令
+ 客户端收到出牌指令后，显示出牌和不出按钮，然后用 `mousePressEvent` 开始记录选中的牌；当出牌按钮被点击，调用比较牌型大小函数判断出牌是否合法，不合法则给出提示，否则向服务器发送出牌，如果不出则发送出牌为空
+ 服务器收到出牌信息后，先向所有客户端广播出牌信息，客户端收到信息后在各自的界面上进行显示；如果某一玩家牌已出完，则广播游戏结束信息，否则向下一个客户端发送出牌指令

### 重新开始

+ 客户端接收到游戏结束信息后，先弹出“你赢了”或“你输了”窗口，然后显示再玩一次按钮，如果玩家点击则向服务器发送再玩一次信息
+ 服务器接收到三个客户端的再玩一次信息后，广播重新开始信息令客户端重新初始化本地数据，然后进入发牌和叫地主阶段

## 踩坑记录

+ 接受信息最好使用信号槽机制，阻塞的效果不佳
+ 利用 `Qt` 自带的json包在服务器、客户端之间传输数据十分方便
+ 可以在 `main.cpp` 中一开始就新建三个 `MainWindow` 从而一次编译运行出三个窗口，但这三个窗口会共享 `MainWindow` 子类 `UICard` 中的静态变量
  + 如果采用 `UICard` 静态变量记录牌的缩放大小，会产生三个窗口互相干扰的情况，因此静态变量要慎用
+ 面对这样较大的工程时，开始写代码前应充分理清设计思路和逻辑，否则很容易无从下手、频繁重构代码