# 豆瓣电影检索系统设计文档

计97 胡沐彦 2019013269

## 功能介绍与展示

目前网站可通过http://39.105.93.197/访问。

+ 网站主页面为电影列表页。所有网站都可在顶部通过按钮访问电影列表和演员列表，并进行影视/演员/影评的搜索。

+ 电影列表页中每部电影以卡片的形式给出，包含海报图片、电影标题、年份、长度，可以通过点击详情按钮或图片进入电影页面。演员列表页和搜索结果列表页的展示方式类似。

+ 所有页面底部都可点击返回顶部，电影、演员、搜索结果列表页的底部有进行页面跳转的按钮，也可输入页面进行跳转。
+ 电影页面包括电影名、海报、剧情简介、上映年份和片长，列出了5条评论和前10个演员，可以通过点击跳转到这10个演员的界面。
+ 演员界面包括演员姓名、图片、简介、性别、出生地，并用和电影列表页同样的方式列出演员的参演影视，此外还统计了与其合作次数最多的前10位演员。用户同样也可以通过点击跳转到这10个演员的界面。

## 爬虫与后端数据查询

+ 共爬取豆瓣1000部电影、6282名演员的信息，在1天内完成所有爬取，信息以json格式存取
+ 完成爬取后将所有信息导入至Django自带的数据库中，分为电影、演员、影评3个table，并建立电影与演员多对多关系、电影与影评的一对多关系
+ 搜索时直接通过Django提供的接口进行筛选，利用Python `time.time` 统计时间，查询耗时都在0.1秒以内

## 各功能的实现细节

### 爬虫

+ 主要采用Python的 `urllib` 库获取HTML源码，然后通过正则表达式提取信息
+ 先利用浏览器开发者工具得到电影的链接列表；影评爬取在豆瓣专门的影评页面上进行（HTML代码格式更统一）
+ 获取页面时加入User-Agent消息头伪装，实测可以以随机sleep $2\sim 3$ 秒的速度持续爬取
+ 通过 `html.unescape` 对HTML转义字符进行转换，然后利用 `json.dumps` 进行存储

### 网站后端

+ 信息检索见上一节“爬虫与后端数据查询”
+ 所有计算工作（包括底部应显示哪些页面跳转按钮）都在后端完成
+ 列表页的页码、搜索页的关键词和搜索类型都通过发送HTML的get请求实现
+ 网站分页通过Django的 `Paginator` 实现

### 网站前端

+ 电影列表、电影卡片的显示使用了Bootstrap的Album模板
+ 演员和影评的显示使用了Bootstrap的card组件
+ 翻页按钮参考了Bootstrap的paginator组件

## 踩坑记录

+ 爬虫被封时，可以通过路由器重播切换ip，写一个自动重播脚本就能连续满速爬取
+ Django在 `migrate` 向数据库导入数据时，一旦有一次报错，之后即使运行 `makemigrations` 再 `migrate` 也会先执行报错的Python migrate代码，只能通过修改错误的Python migrate源码避免这个问题
  + 善用一些简单的SQL语句，如 `.table` 查看已有的数据库，`DELETE FROM` 清空一个数据库
+ 开发网站时尽量先搭建好后端框架，然后逐步完善前端细节，一开始就美化前端可能之后需要重构代码，会耗费大量时间